<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CircuitGuard AI â€” PCB Defect Detection</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
  :root {
    --bg:#0a0f24; --card:#0f1a33; --accent:#00c6ff;
    --muted:#9ec9ff; --white:#e0e6ed;
  }
  body {
    margin:0;
    font-family:'Inter',sans-serif;
    background:radial-gradient(circle at top left,#050918 0%,#0a0e27 60%,#11163a 100%);
    color:var(--white);
  }
  header {
    text-align:center;
    padding:40px 20px;
    border-bottom:2px solid rgba(0,198,255,0.4);
    background:linear-gradient(90deg,rgba(10,20,40,0.9),rgba(20,40,80,0.9));
  }
  header h1 {
    font-family:'Orbitron',sans-serif;
    font-size:2.8em;
    font-weight:900;
    background:linear-gradient(135deg,#00c6ff,#ff00ff);
background-clip: text;
-webkit-background-clip: text;
color: transparent;
    -webkit-text-fill-color:transparent;
    margin:0;
  }
  .container { max-width:1150px; margin:40px auto; padding:0 20px; }
  .card {
    background:rgba(15,25,45,0.9);
    border:1px solid rgba(0,198,255,0.2);
    border-radius:16px;
    padding:24px;
    margin-bottom:24px;
    box-shadow:0 10px 30px rgba(0,198,255,0.15);
  }
  .file-input { display:none; }
  .file-btn {
    padding:12px 18px;
    border-radius:10px;
    background:linear-gradient(135deg,#00c6ff,#0072ff);
    color:#fff; font-weight:700;
    border:none; cursor:pointer;
  }
  .controls { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .controls input {
    padding:8px; border-radius:8px;
    border:1px solid rgba(0,198,255,0.25);
    background:#0d1530; color:var(--white);
    width:130px;
  }
  .analyze-btn {
    display:block; width:100%; margin-top:20px;
    padding:16px; border-radius:12px;
    background:linear-gradient(135deg,#f093fb,#f5576c);
    color:#fff; font-size:1.2em;
    font-family:'Orbitron'; cursor:pointer; border:none;
  }
  .section-title {
    font-family:'Orbitron',sans-serif;
    color:#00c6ff; font-size:1.8em;
    text-align:center; margin-top:40px;
  }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th,td {
    padding:10px; border-bottom:1px solid rgba(255,255,255,0.08);
    text-align:left;
  }
  th { color:var(--muted); }
  .downloads { display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; justify-content:center; }
  .downloads button {
    padding:12px 16px; border:none; border-radius:10px;
    background:linear-gradient(135deg,#00c6ff,#0072ff);
    color:#fff; font-weight:700; cursor:pointer;
  }
  .chart-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:18px; margin-top:24px;
  }
  .chart-grid canvas {
    background:#081028;
    border-radius:10px;
    padding:8px;
    height:240px !important;
  }
  .footer-note {
    font-size:0.9em; color:var(--muted);
    text-align:center; margin-top:20px;
  }
</style>
</head>
<body>

<header>
  <h1>CIRCUITGUARD AI</h1>
  <p style="color:#00c6ff;letter-spacing:3px">Next-Gen PCB Defect Detection</p>
</header>

<div class="container">
  <div class="card">
    <h2 style="text-align:center;color:#00c6ff">Upload PCB Images</h2>
    <div style="display:flex;gap:20px;flex-wrap:wrap;justify-content:space-between;">
      <div>
        <label class="file-btn" for="templateFile">Upload Template PCB</label>
        <input id="templateFile" class="file-input" type="file" accept="image/*">
        <div id="templateName" style="color:var(--muted);margin-top:8px">No file chosen</div>
      </div>
      <div>
        <label class="file-btn" for="testFile">Upload Test PCB</label>
        <input id="testFile" class="file-input" type="file" accept="image/*">
        <div id="testName" style="color:var(--muted);margin-top:8px">No file chosen</div>
      </div>
    </div>

    <div class="controls">
      <label>Diff Thresh <input id="diff" type="number" value="30"></label>
      <label>Min ROI Area <input id="minarea" type="number" value="50"></label>
      <label>Conf Thresh <input id="conf" type="number" step="0.05" value="0.6"></label>
    </div>

    <button class="analyze-btn" id="analyzeBtn">ðŸš€ Analyze PCB</button>
    <div id="status" style="color:var(--muted);margin-top:8px">Ready</div>
    <div style="margin-top:14px;text-align:center;">
      <a href="/history" style="color:#00c6ff">ðŸ§¾ Open History Page</a>
    </div>
  </div>

  <div class="card" id="resultsCard" style="display:none;">
    <h2 class="section-title">Defect Summary</h2>
    <div style="text-align:center;">
      <img id="annotatedImg" src="" alt="Annotated PCB" style="max-width:90%;border-radius:10px;margin-top:10px;">
    </div>

    <h3 style="margin-top:20px;color:#00c6ff;">Summary Details</h3>
    <div id="summaryBlock" style="color:var(--muted)"></div>

    <table id="defectTable">
      <thead><tr><th>ID</th><th>Class</th><th>Confidence (%)</th><th>Area (pxÂ²)</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="downloads">
      <button id="pdfBtn">ðŸ“„ PDF</button>
      <button id="csvBtn">ðŸ“Š CSV</button>
      <button id="annotBtn">ðŸ–¼ Annotated</button>
      <button id="diffBtn">ðŸ©¸ Diff</button>
      <button id="maskBtn">â¬› Binary Mask</button>
    </div>

    <h2 class="section-title">Defect Analysis Charts</h2>
    <div class="chart-grid">
      <canvas id="barChart"></canvas>
      <canvas id="pieChart"></canvas>
      <canvas id="scatterChart" style="max-width:100%;max-height:240px;"></canvas>
    </div>
  </div>

  <div class="card footer-note">
    <div>Quick: Upload both Template & Test, adjust thresholds and press Analyze. Downloads saved in server /outputs.</div>
  </div>
</div>

<footer style="text-align:center;color:var(--muted);padding:20px">
  Â© 2025 CircuitGuard AI â€” Intelligent PCB Analytics
</footer>

<script>
  const API_BASE = location.origin;
  const STORAGE_KEY = "circuitguard_last_run";

  const tFile = document.getElementById("templateFile");
  const sFile = document.getElementById("testFile");
  const statusBox = document.getElementById("status");
  const resultsCard = document.getElementById("resultsCard");
  const annotatedImg = document.getElementById("annotatedImg");
  const defectTableBody = document.querySelector("#defectTable tbody");
  const summaryBlock = document.getElementById("summaryBlock");
  const diffInput = document.getElementById("diff");
  const minAreaInput = document.getElementById("minarea");
  const confInput = document.getElementById("conf");
  const templateNameEl = document.getElementById("templateName");
  const testNameEl = document.getElementById("testName");

  let lastReportId = null, lastPdf = null, lastCsv = null;
  let barChart, pieChart, scatterChart;

  tFile.addEventListener("change", e => {
    templateNameEl.textContent = e.target.files[0]?.name || "No file chosen";
  });
  sFile.addEventListener("change", e => {
    testNameEl.textContent = e.target.files[0]?.name || "No file chosen";
  });

  function setStatus(msg){ statusBox.textContent = msg; }

  // ---------- STATE SAVE / RESTORE ----------
  function saveState(data){
    const state = {
      diff: diffInput.value,
      minarea: minAreaInput.value,
      conf: confInput.value,
      templateName: templateNameEl.textContent,
      testName: testNameEl.textContent,
      report_id: data.report_id,
      pdf_path: data.pdf_path,
      csv_path: data.csv_path,
      total: data.total_defects_detected,
      statistics: data.statistics,
      predictions: data.predictions,
      annotated_b64: data.overview_images.annotated_results
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function restoreState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const st = JSON.parse(raw);

      diffInput.value = st.diff ?? 30;
      minAreaInput.value = st.minarea ?? 50;
      confInput.value = st.conf ?? 0.6;
      templateNameEl.textContent = st.templateName || "No file chosen";
      testNameEl.textContent = st.testName || "No file chosen";

      lastReportId = st.report_id || null;
      lastPdf = st.pdf_path || null;
      lastCsv = st.csv_path || null;

      if(st.annotated_b64){
        annotatedImg.src = "data:image/png;base64," + st.annotated_b64;
      }

      // summary
      if(st.statistics){
        summaryBlock.innerHTML =
          `Detected <b>${st.total}</b> defects â€” Avg Confidence: <b>${(st.statistics.avg_conf*100).toFixed(1)}%</b>`;
      }

      // table + charts
      defectTableBody.innerHTML = "";
      (st.predictions || []).forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML =
          `<td>#${p.defect_id}</td><td>${p.class}</td>`+
          `<td>${(p.confidence*100).toFixed(1)}</td><td>${Math.round(p.area||0)}</td>`;
        defectTableBody.appendChild(tr);
      });
      renderCharts(st.predictions || []);

      resultsCard.style.display = "block";
      setStatus("Restored last analysis âœ…");
    }catch(e){
      console.warn("Failed to restore previous state:", e);
    }
  }

  document.getElementById("analyzeBtn").addEventListener("click", async ()=>{
    if(!tFile.files[0] || !sFile.files[0]) return alert("Please upload both images!");
    setStatus("Analyzing...");
    resultsCard.style.display="none";
    defectTableBody.innerHTML="";
    summaryBlock.innerHTML="";

    const fd = new FormData();
    fd.append("template_file", tFile.files[0]);
    fd.append("test_file", sFile.files[0]);
    fd.append("difference_threshold", Number(diffInput.value));
    fd.append("min_roi_area", Number(minAreaInput.value));
    fd.append("confidence_threshold", Number(confInput.value));
    fd.append("generate_report", true);

    try{
      const res = await fetch(API_BASE+"/predict",{method:"POST",body:fd});
      if(!res.ok) throw new Error("Server Error");
      const data = await res.json();

      lastReportId=data.report_id;
      lastPdf=data.pdf_path;
      lastCsv=data.csv_path;

      annotatedImg.src="data:image/png;base64,"+(data.overview_images.annotated_results||"");
      summaryBlock.innerHTML=
        `Detected <b>${data.total_defects_detected}</b> defects â€” Avg Confidence: <b>${(data.statistics.avg_conf*100).toFixed(1)}%</b>`;

      data.predictions.forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=
          `<td>#${p.defect_id}</td><td>${p.class}</td>`+
          `<td>${(p.confidence*100).toFixed(1)}</td><td>${Math.round(p.area||0)}</td>`;
        defectTableBody.appendChild(tr);
      });

      renderCharts(data.predictions);

      // SAVE STATE for coming back from history / refresh
      saveState(data);

      resultsCard.style.display="block";
      setStatus("Done âœ…");
    }catch(e){
      alert("Error: "+e.message);
      setStatus("Error!");
    }
  });

  function renderCharts(preds){
    const counts={}, pts=[];
    preds.forEach(p=>{
      counts[p.class]=(counts[p.class]||0)+1;
      pts.push({x:p.position_xy[0],y:p.position_xy[1]});
    });
    const labels=Object.keys(counts), vals=Object.values(counts);

    if(barChart) barChart.destroy();
    if(pieChart) pieChart.destroy();
    if(scatterChart) scatterChart.destroy();

    barChart=new Chart(document.getElementById("barChart"),{
      type:"bar",
      data:{labels:labels,datasets:[{data:vals,backgroundColor:"#00c6ff"}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    pieChart=new Chart(document.getElementById("pieChart"),{
      type:"pie",
      data:{labels:labels,datasets:[{data:vals,backgroundColor:["#00c6ff","#f093fb","#f5576c","#6c63ff","#36d1dc","#ff6a00"]}]},
      options:{plugins:{legend:{position:'bottom'}}}
    });

    scatterChart=new Chart(document.getElementById("scatterChart"),{
      type:"scatter",
      data:{datasets:[{label:"Defects",data:pts,backgroundColor:"#00c6ff"}]},
      options:{
        maintainAspectRatio:true,responsive:true,
        plugins:{legend:{display:false}},
        scales:{x:{title:{display:true,text:"X"}},y:{title:{display:true,text:"Y"}}}
      }
    });
  }

  // download handlers
  document.getElementById("pdfBtn").addEventListener("click",()=>{
    if(!lastPdf)return alert("No PDF");
    window.open(`/download-pdf/${lastPdf}`,'_blank');
  });
  document.getElementById("csvBtn").addEventListener("click",()=>{
    if(!lastReportId)return alert("No CSV");
    window.open(`/download-csv/${lastReportId}`,'_blank');
  });
  document.getElementById("annotBtn").addEventListener("click",()=>{
    if(!lastReportId)return alert("No report yet");
    window.open(`/download-image/${lastReportId}/annotated`,'_blank');
  });
  document.getElementById("diffBtn").addEventListener("click",()=>{
    if(!lastReportId)return alert("No report yet");
    window.open(`/download-image/${lastReportId}/diff`,'_blank');
  });
  document.getElementById("maskBtn").addEventListener("click",()=>{
    if(!lastReportId)return alert("No report yet");
    window.open(`/download-image/${lastReportId}/mask`,'_blank');
  });

  // restore last run when page loads
  window.addEventListener("load", restoreState);
</script>
</body>
</html>
